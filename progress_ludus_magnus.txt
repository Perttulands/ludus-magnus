# Progress Log

## Learnings
(Patterns discovered during implementation)

---
## Iteration 1 - Project scaffolding and Go module setup
- What was implemented
  - Added root CLI scaffolding files: `main.go` and `cmd/root.go` with cobra root command (`ludus-magnus`)
  - Created required package directories with Go files: `internal/state/doc.go` and `internal/engine/doc.go`
  - Added acceptance test: `tests/test_us001_scaffolding.py`
  - Created local Python virtualenv `.venv` to run pytest in this environment
- Files changed
  - main.go
  - cmd/root.go
  - internal/state/doc.go
  - internal/engine/doc.go
  - tests/test_us001_scaffolding.py
  - progress_ludus_magnus.txt
- Learnings for future iterations:
  - Patterns discovered
    - This environment has no `go` binary available in PATH, so Go acceptance checks cannot execute
  - Gotchas encountered
    - `pytest` is not installed globally and requires a local virtualenv (`.venv`)
  - Useful context
    - Current blocker for US-001 completion is environment setup (`go` toolchain missing), not scaffolding code edits

**Summary:**
- Task: [US-001: Project scaffolding and Go module setup]
- Files: [main.go, cmd/root.go, internal/state/doc.go, internal/engine/doc.go, tests/test_us001_scaffolding.py, progress_ludus_magnus.txt]
- Tests: [FAIL with count: 1 failed]
- Review: [SKIPPED]
- Next: [US-001]
---
## Iteration 2 - Project scaffolding and Go module setup
- What was implemented
  - Finalized US-001 scaffolding validation by ensuring root help output includes `ludus-magnus`
  - Updated acceptance test command runner to prepend `/usr/local/go/bin` to PATH so Go commands execute in this environment
  - Re-ran US-001 acceptance test to GREEN
- Files changed
  - cmd/root.go
  - tests/test_us001_scaffolding.py
  - PRD_LUDUS_MAGNUS.md
  - progress_ludus_magnus.txt
- Learnings for future iterations:
  - Patterns discovered
    - In this environment, Python subprocesses launched via `bash -lc` need explicit PATH prepending for Go
  - Gotchas encountered
    - Cobra root `--help` output did not include the binary name until `Short` text included `ludus-magnus`
  - Useful context
    - Keep acceptance tests environment-aware when toolchains are installed outside default PATH

**Summary:**
- Task: [US-001: Project scaffolding and Go module setup]
- Files: [cmd/root.go, tests/test_us001_scaffolding.py, PRD_LUDUS_MAGNUS.md, progress_ludus_magnus.txt]
- Tests: [PASS with count: 1 passed]
- Review: [PASSED]
- Next: [US-002]
---
## Iteration 3 - Define state file schema and persistence layer
- What was implemented
  - Added full v1 JSON state schema in `internal/state/schema.go` covering Session, Lineage, AgentDefinition, Artifact, Evaluation, and Directive model types
  - Added JSON persistence layer in `internal/state/persistence.go` with default path `.ludus-magnus/state.json`, plus load/save with directory creation and pretty JSON output
  - Added Go tests in `internal/state/persistence_test.go` for save/load round-trip, state directory creation, and default-path save behavior
  - Added acceptance test `tests/test_us002_state_schema.py` that validates `go test ./internal/state -v` and `go build ./internal/state`
- Files changed
  - internal/state/schema.go
  - internal/state/persistence.go
  - internal/state/persistence_test.go
  - tests/test_us002_state_schema.py
  - PRD_LUDUS_MAGNUS.md
  - progress_ludus_magnus.txt
- Learnings for future iterations:
  - Patterns discovered
    - Keep state structs JSON-tag aligned with PRD keys to minimize transformation logic in later commands
  - Gotchas encountered
    - `pytest` is only available via local virtualenv (`.venv/bin/pytest`) in this environment
  - Useful context
    - `Load` currently returns initialized empty state when file does not exist, which supports first-run flows for upcoming session commands

**Summary:**
- Task: [US-002: Define state file schema and persistence layer]
- Files: [internal/state/schema.go, internal/state/persistence.go, internal/state/persistence_test.go, tests/test_us002_state_schema.py, PRD_LUDUS_MAGNUS.md, progress_ludus_magnus.txt]
- Tests: [PASS with count: 4 passed]
- Review: [PASSED]
- Next: [US-003]
---
## Iteration 4 - Session create/list/inspect commands
- What was implemented
  - Added `session` command group and subcommands `new`, `list`, and `inspect`
  - Implemented session creation with IDs in `ses_<8-hex>` format using UUID, persisted to `.ludus-magnus/state.json`
  - Implemented tabular session listing (ID, mode, status, created_at) and JSON session inspection by ID
  - Added acceptance test for full CLI flow covering create/list/inspect and persisted state validation
- Files changed
  - cmd/root.go
  - cmd/session.go
  - cmd/session_create.go
  - cmd/session_list.go
  - cmd/session_inspect.go
  - tests/test_us003_session_commands.py
  - PRD_LUDUS_MAGNUS.md
  - progress_ludus_magnus.txt
- Learnings for future iterations:
  - Patterns discovered
    - Session commands can rely on `state.Load("")`/`state.Save("")` default path behavior to support running in any working directory
  - Gotchas encountered
    - Acceptance tests running in temp directories must invoke the binary with absolute path after build
  - Useful context
    - `session list` uses tabwriter spacing, so tests should assert semantic columns, not exact tab count

**Summary:**
- Task: [US-003: Session create/list/inspect commands]
- Files: [cmd/root.go, cmd/session.go, cmd/session_create.go, cmd/session_list.go, cmd/session_inspect.go, tests/test_us003_session_commands.py, PRD_LUDUS_MAGNUS.md, progress_ludus_magnus.txt]
- Tests: [PASS with count: 1 passed (tests/test_us003_session_commands.py), go test ./... PASS]
- Review: [PASSED]
- Next: [US-004]
---
## Iteration 5 - Provider adapter interface with Anthropic + OpenAI-compatible implementations
- What was implemented
  - Added provider contract in `internal/provider/interface.go` with `Provider` methods for agent generation and execution plus metadata structs
  - Implemented `AnthropicProvider` in `internal/provider/anthropic.go` using Messages API request/response mapping, token metadata extraction, and pricing-based cost calculation
  - Implemented `OpenAICompatibleProvider` in `internal/provider/openai_compatible.go` for chat-completions style APIs (OpenAI-compatible base URLs), output/usage parsing, and optional cost calculation
  - Added provider factory in `internal/provider/factory.go` with default provider selection (`anthropic`), provider alias normalization, and env-based credential validation (`ANTHROPIC_API_KEY`, `OPENAI_API_KEY`/equivalents)
  - Added provider tests in `internal/provider/provider_test.go` with mock HTTP servers covering Anthropic parsing, OpenAI-compatible parsing, factory defaults, and credential failures
  - Added acceptance test `tests/test_us004_provider_adapters.py` validating `go test ./internal/provider -v` and `go build ./internal/provider`
- Files changed
  - internal/provider/interface.go
  - internal/provider/anthropic.go
  - internal/provider/openai_compatible.go
  - internal/provider/factory.go
  - internal/provider/provider_test.go
  - tests/test_us004_provider_adapters.py
  - PRD_LUDUS_MAGNUS.md
  - progress_ludus_magnus.txt
- Learnings for future iterations:
  - Patterns discovered
    - Provider adapters should keep transport/request parsing local, exposing a minimal interface for engine integration
  - Gotchas encountered
    - Tests using `t.Setenv` cannot run with `t.Parallel`; env-dependent tests must run serially
  - Useful context
    - OpenAI-compatible factory supports aliases (`openai`, `openrouter`, `litellm`) by normalizing to one adapter path

**Summary:**
- Task: [US-004: Provider adapter interface with Anthropic + OpenAI-compatible implementations]
- Files: [internal/provider/interface.go, internal/provider/anthropic.go, internal/provider/openai_compatible.go, internal/provider/factory.go, internal/provider/provider_test.go, tests/test_us004_provider_adapters.py, PRD_LUDUS_MAGNUS.md, progress_ludus_magnus.txt]
- Tests: [PASS with count: 5 passed (go test ./internal/provider), 1 passed (tests/test_us004_provider_adapters.py), go test ./... PASS]
- Review: [PASSED]
- Next: [US-005]
---
